apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana
  namespace: argocd
spec:
  project: cluster
  source:
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 8.3.0
    chart: grafana
    helm:
      releaseName: grafana
      values: |
        replicas: 1

        adminPassword: admin

        persistence:
          enabled: false

        auth:
          anonymous:
            enabled: true
            org_role: Viewer

        grafana.ini:
          auth.anonymous:
            enabled: true
            org_role: Viewer
          users:
            allow_sign_up: false

        service:
          type: ClusterIP
          port: 80
          targetPort: 3000

        ingress:
          enabled: true
          ingressClassName: nginx
          hosts:
            - grafana.lan
          path: /
          pathType: Prefix

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi

        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
            - name: Prometheus
              type: prometheus
              url: http://prometheus-server.monitoring.svc.cluster.local:80
              access: proxy
              isDefault: true
            - name: Loki
              type: loki
              url: http://loki.monitoring.svc.cluster.local:3100
              access: proxy

        dashboardProviders:
          dashboardproviders.yaml:
            apiVersion: 1
            providers:
            - name: 'default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/default

        dashboards:
          default:
            cluster-overview:
              json: |
                {
                  "annotations": {
                    "list": [
                      {
                        "builtIn": 1,
                        "datasource": {
                          "type": "grafana",
                          "uid": "-- Grafana --"
                        },
                        "enable": true,
                        "hide": true,
                        "iconColor": "rgba(0, 211, 255, 1)",
                        "name": "Annotations & Alerts",
                        "type": "dashboard"
                      }
                    ]
                  },
                  "editable": true,
                  "fiscalYearStartMonth": 0,
                  "graphTooltip": 0,
                  "id": null,
                  "links": [],
                  "liveNow": false,
                  "panels": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "mappings": [],
                          "thresholds": {
                            "base": {
                              "color": "green",
                              "value": null
                            },
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              },
                              {
                                "color": "yellow",
                                "value": 50
                              },
                              {
                                "color": "red",
                                "value": 80
                              }
                            ]
                          },
                          "unit": "percent"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 8,
                        "w": 12,
                        "x": 0,
                        "y": 0
                      },
                      "id": 2,
                      "options": {
                        "colorMode": "background",
                        "graphMode": "none",
                        "justifyMode": "auto",
                        "orientation": "auto",
                        "reduceOptions": {
                          "values": false,
                          "fields": "",
                          "calcs": [
                            "lastNotNull"
                          ]
                        },
                        "text": {},
                        "textMode": "auto"
                      },
                      "pluginVersion": "10.0.0",
                      "targets": [
                        {
                          "expr": "(1 - avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))) * 100",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "CPU Usage %",
                          "refId": "A"
                        }
                      ],
                      "title": "Node CPU Usage",
                      "type": "stat"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "mappings": [],
                          "thresholds": {
                            "base": {
                              "color": "green",
                              "value": null
                            },
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              },
                              {
                                "color": "yellow",
                                "value": 50
                              },
                              {
                                "color": "red",
                                "value": 80
                              }
                            ]
                          },
                          "unit": "percent"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 8,
                        "w": 12,
                        "x": 12,
                        "y": 0
                      },
                      "id": 3,
                      "options": {
                        "colorMode": "background",
                        "graphMode": "none",
                        "justifyMode": "auto",
                        "orientation": "auto",
                        "reduceOptions": {
                          "values": false,
                          "fields": "",
                          "calcs": [
                            "lastNotNull"
                          ]
                        },
                        "text": {},
                        "textMode": "auto"
                      },
                      "pluginVersion": "10.0.0",
                      "targets": [
                        {
                          "expr": "((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * 100",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "Memory Usage %",
                          "refId": "A"
                        }
                      ],
                      "title": "Node Memory Usage",
                      "type": "stat"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "palette-classic"
                          },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "Cores",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "none",
                            "hideFrom": {
                              "tooltip": false,
                              "viz": false,
                              "legend": false
                            },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": {
                              "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": true,
                            "stacking": {
                              "group": "A",
                              "mode": "none"
                            },
                            "thresholdsStyle": {
                              "mode": "off"
                            }
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              }
                            ]
                          },
                          "unit": "short"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 8,
                        "w": 12,
                        "x": 0,
                        "y": 8
                      },
                      "id": 4,
                      "options": {
                        "legend": {
                          "calcs": [],
                          "displayMode": "list",
                          "placement": "bottom",
                          "showLegend": true
                        },
                        "tooltip": {
                          "mode": "multi",
                          "sort": "none"
                        }
                      },
                      "pluginVersion": "10.0.0",
                      "targets": [
                        {
                          "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\".+\", cpu=\"total\"}[5m])) by (pod, namespace)",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "{{pod}} ({{namespace}})",
                          "refId": "A"
                        }
                      ],
                      "title": "Pod CPU Usage",
                      "type": "timeseries"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "palette-classic"
                          },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "Bytes",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "none",
                            "hideFrom": {
                              "tooltip": false,
                              "viz": false,
                              "legend": false
                            },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": {
                              "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": true,
                            "stacking": {
                              "group": "A",
                              "mode": "none"
                            },
                            "thresholdsStyle": {
                              "mode": "off"
                            }
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              }
                            ]
                          },
                          "unit": "bytes"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 8,
                        "w": 12,
                        "x": 12,
                        "y": 8
                      },
                      "id": 5,
                      "options": {
                        "legend": {
                          "calcs": [],
                          "displayMode": "list",
                          "placement": "bottom",
                          "showLegend": true
                        },
                        "tooltip": {
                          "mode": "multi",
                          "sort": "none"
                        }
                      },
                      "pluginVersion": "10.0.0",
                      "targets": [
                        {
                          "expr": "sum(container_memory_working_set_bytes{namespace=~\".+\"}) by (pod, namespace)",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "{{pod}} ({{namespace}})",
                          "refId": "A"
                        }
                      ],
                      "title": "Pod Memory Usage",
                      "type": "timeseries"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "palette-classic"
                          },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "Restarts",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "bars",
                            "fillOpacity": 100,
                            "gradientMode": "none",
                            "hideFrom": {
                              "tooltip": false,
                              "viz": false,
                              "legend": false
                            },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": {
                              "type": "linear"
                            },
                            "showPoints": "never",
                            "spanNulls": true,
                            "stacking": {
                              "group": "A",
                              "mode": "none"
                            },
                            "thresholdsStyle": {
                              "mode": "off"
                            }
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              }
                            ]
                          },
                          "unit": "short"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 8,
                        "w": 12,
                        "x": 0,
                        "y": 16
                      },
                      "id": 6,
                      "options": {
                        "legend": {
                          "calcs": [],
                          "displayMode": "list",
                          "placement": "bottom",
                          "showLegend": true
                        },
                        "tooltip": {
                          "mode": "multi",
                          "sort": "none"
                        }
                      },
                      "pluginVersion": "10.0.0",
                      "targets": [
                        {
                          "expr": "increase(kube_pod_container_status_restarts_total[1h])",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "{{pod}} ({{namespace}})",
                          "refId": "A"
                        }
                      ],
                      "title": "Pod Restarts (1h)",
                      "type": "timeseries"
                    },
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "fieldConfig": {
                        "defaults": {
                          "color": {
                            "mode": "palette-classic"
                          },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "Bytes/sec",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "none",
                            "hideFrom": {
                              "tooltip": false,
                              "viz": false,
                              "legend": false
                            },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": {
                              "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": true,
                            "stacking": {
                              "group": "A",
                              "mode": "none"
                            },
                            "thresholdsStyle": {
                              "mode": "off"
                            }
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              {
                                "color": "green",
                                "value": null
                              }
                            ]
                          },
                          "unit": "Bps"
                        },
                        "overrides": []
                      },
                      "gridPos": {
                        "h": 8,
                        "w": 12,
                        "x": 12,
                        "y": 16
                      },
                      "id": 7,
                      "options": {
                        "legend": {
                          "calcs": [],
                          "displayMode": "list",
                          "placement": "bottom",
                          "showLegend": true
                        },
                        "tooltip": {
                          "mode": "multi",
                          "sort": "none"
                        }
                      },
                      "pluginVersion": "10.0.0",
                      "targets": [
                        {
                          "expr": "rate(node_network_receive_bytes_total{device=\"eth0\"}[5m])",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "RX",
                          "refId": "A"
                        },
                        {
                          "expr": "rate(node_network_transmit_bytes_total{device=\"eth0\"}[5m])",
                          "format": "time_series",
                          "interval": "",
                          "legendFormat": "TX",
                          "refId": "B"
                        }
                      ],
                      "title": "Node Network I/O",
                      "type": "timeseries"
                    }
                  ],
                  "refresh": "30s",
                  "schemaVersion": 38,
                  "style": "dark",
                  "tags": [
                    "cluster",
                    "overview"
                  ],
                  "templating": {
                    "list": []
                  },
                  "time": {
                    "from": "now-1h",
                    "to": "now"
                  },
                  "timepicker": {},
                  "timezone": "",
                  "title": "Cluster Overview",
                  "uid": "cluster-overview",
                  "version": 1
                }
            loki-metrics:
              json: |
                {
                  "annotations": {
                    "list": [
                      {
                        "builtIn": 1,
                        "datasource": { "type": "grafana", "uid": "-- Grafana --" },
                        "enable": true,
                        "hide": true,
                        "iconColor": "rgba(0, 211, 255, 1)",
                        "name": "Annotations & Alerts",
                        "type": "dashboard"
                      }
                    ]
                  },
                  "editable": true,
                  "fiscalYearStartMonth": 0,
                  "graphTooltip": 0,
                  "id": null,
                  "links": [],
                  "panels": [
                    {
                      "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                      "fieldConfig": {
                        "defaults": {
                          "color": { "mode": "palette-classic" },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "bars",
                            "fillOpacity": 100,
                            "gradientMode": "none",
                            "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": { "type": "linear" },
                            "showPoints": "never",
                            "spanNulls": true,
                            "stacking": { "group": "A", "mode": "normal" },
                            "thresholdsStyle": { "mode": "off" }
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              { "color": "green", "value": null }
                            ]
                          },
                          "unit": "short"
                        },
                        "overrides": []
                      },
                      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                      "id": 1,
                      "options": {
                        "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true },
                        "tooltip": { "mode": "multi", "sort": "none" }
                      },
                      "targets": [
                        {
                          "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                          "expr": "sum(count_over_time({namespace=~\".+\"}[2m])) by (namespace)",
                          "legendFormat": "{{namespace}}",
                          "refId": "A"
                        }
                      ],
                      "title": "Log Volume by Namespace",
                      "type": "timeseries"
                    },
                    {
                      "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                      "fieldConfig": {
                        "defaults": {
                          "color": { "mode": "palette-classic" },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "bars",
                            "fillOpacity": 100,
                            "gradientMode": "none",
                            "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": { "type": "linear" },
                            "showPoints": "never",
                            "spanNulls": true,
                            "stacking": { "group": "A", "mode": "none" },
                            "thresholdsStyle": { "mode": "off" }
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              { "color": "green", "value": null }
                            ]
                          },
                          "unit": "short"
                        },
                        "overrides": []
                      },
                      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                      "id": 2,
                      "options": {
                        "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true },
                        "tooltip": { "mode": "multi", "sort": "none" }
                      },
                      "targets": [
                        {
                          "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                          "expr": "sum(count_over_time({namespace=~\".+\"}[2m])) by (pod, namespace)",
                          "legendFormat": "{{pod}} ({{namespace}})",
                          "refId": "A"
                        }
                      ],
                      "title": "Log Volume by Pod",
                      "type": "timeseries"
                    },
                    {
                      "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                      "fieldConfig": {
                        "defaults": {
                          "color": { "mode": "palette-classic" },
                          "custom": {
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "bars",
                            "fillOpacity": 100,
                            "gradientMode": "none",
                            "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": { "type": "linear" },
                            "showPoints": "never",
                            "spanNulls": true,
                            "stacking": { "group": "A", "mode": "normal" },
                            "thresholdsStyle": { "mode": "off" }
                          },
                          "color": { "mode": "thresholds" },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              { "color": "green", "value": null },
                              { "color": "yellow", "value": 10 },
                              { "color": "red", "value": 50 }
                            ]
                          },
                          "unit": "short"
                        },
                        "overrides": [
                          { "matcher": { "id": "byName", "options": "error" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }] },
                          { "matcher": { "id": "byName", "options": "warn" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "yellow" } }] },
                          { "matcher": { "id": "byName", "options": "info" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "blue" } }] }
                        ]
                      },
                      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 8 },
                      "id": 3,
                      "options": {
                        "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true },
                        "tooltip": { "mode": "multi", "sort": "none" }
                      },
                      "targets": [
                        {
                          "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                          "expr": "sum(count_over_time({namespace=~\".+\"} |~ \"(?i)error\" [2m]))",
                          "legendFormat": "error",
                          "refId": "A"
                        },
                        {
                          "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                          "expr": "sum(count_over_time({namespace=~\".+\"} |~ \"(?i)warn\" [2m]))",
                          "legendFormat": "warn",
                          "refId": "B"
                        },
                        {
                          "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                          "expr": "sum(count_over_time({namespace=~\".+\"} |~ \"(?i)info\" [2m]))",
                          "legendFormat": "info",
                          "refId": "C"
                        }
                      ],
                      "title": "Log Levels (2m rate)",
                      "type": "timeseries"
                    },
                    {
                      "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                      "fieldConfig": {
                        "defaults": {
                          "color": { "mode": "palette-classic" },
                          "custom": {
                            "align": "auto",
                            "cellOptions": { "type": "auto" },
                            "inspect": false,
                            "filterable": true,
                            "sortBy": [{ "displayName": "Time", "desc": true }]
                          },
                          "mappings": [],
                          "thresholds": {
                            "mode": "absolute",
                            "steps": [
                              { "color": "green", "value": null }
                            ]
                          }
                        },
                        "overrides": [
                          { "matcher": { "id": "byName", "options": "Time" }, "properties": [{ "id": "custom.width", "value": 150 }] },
                          { "matcher": { "id": "byName", "options": "pod" }, "properties": [{ "id": "custom.width", "value": 150 }] },
                          { "matcher": { "id": "byName", "options": "namespace" }, "properties": [{ "id": "custom.width", "value": 100 }] },
                          { "matcher": { "id": "byName", "options": "Line" }, "properties": [{ "id": "custom.width", "value": 500 } ] }
                        ]
                      },
                      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 16 },
                      "id": 4,
                      "options": {
                        "showHeader": true,
                        "sortBy": [{ "displayName": "Time", "desc": true }]
                      },
                      "targets": [
                        {
                          "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
                          "expr": "{namespace=~\".+\"} |~ \"(?i)error\" | decolorize",
                          "refId": "A"
                        }
                      ],
                      "title": "Error Logs",
                      "type": "logs"
                    }
                  ],
                  "refresh": "30s",
                  "schemaVersion": 38,
                  "style": "dark",
                  "tags": ["logs", "loki", "metrics"],
                  "templating": {
                    "list": []
                  },
                  "time": { "from": "now-1h", "to": "now" },
                  "timepicker": {},
                  "timezone": "",
                  "title": "Loki Metrics",
                  "uid": "loki-metrics",
                  "version": 1
                }

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring

  syncPolicy:
    syncOptions:
    - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
